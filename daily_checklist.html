<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Checklist</title>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }

    :root{
      --ink:#111;
      --bg:#ececec;
      --card:#fff;
      --add-blue:#b8e8ff;
      --danger:#ffd6d6;
      --warn:#ffe4a8;
      --pale:#fafafa;
      --done:#e8ffe8;
      --done-strong:#bfeec7; /* slightly deeper green */
      --insert-line:#111;
    }

    body {
      background: var(--bg);
      color: var(--ink);
      font-family: "Comic Sans MS", "Trebuchet MS", system-ui, sans-serif;
      min-height: 100vh;
    }

    .wrap {
      width: 100%;
      max-width: 760px;
      margin: 0 auto;
      padding: 24px 16px 64px;
      position: relative;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .back {
      display: inline-block;
      text-decoration: none;
      color: var(--ink);
      background: #fff6a8;
      border: 3px solid var(--ink);
      box-shadow: -6px 6px 0 var(--ink);
      padding: 8px 12px;
      transform: rotate(-2deg);
    }

    .date {
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .title-wrap{
      position: relative;
      display: grid;
      place-items: center;
      margin: 10px 0 16px;
    }

    .title {
      position: relative;
      margin: 0;
      text-align: center;
      font-size: clamp(30px, 6vw, 48px);
      letter-spacing: 1px;
      text-transform: uppercase;
      text-shadow:
        1px 1px 0 var(--ink),
        -1px 1px 0 var(--ink),
        1px -1px 0 var(--ink),
        -1px -1px 0 var(--ink);
      color: var(--add-blue);
      display: inline-block;
      padding: 2px 6px;
    }

    .title::after{
      content:"";
      position:absolute;
      left:-2%;
      top:55%;
      height:4px;
      width:0%;
      background: var(--ink);
      transform: rotate(-3deg);
      transform-origin: left center;
      opacity: 0;
    }

    .title.done::after{
      animation: titleStrike 700ms ease forwards;
    }

    @keyframes titleStrike{
      0%{ width:0%; opacity:0; }
      20%{ opacity:1; }
      100%{ width:104%; opacity:1; }
    }

    .card {
      background: var(--card);
      border: 3px solid var(--ink);
      box-shadow: -8px 8px 0 var(--ink);
      padding: 14px;
      margin-bottom: 14px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .controls input {
      flex: 1 1 260px;
      border: 2px solid var(--ink);
      padding: 10px 12px;
      font: inherit;
    }

    .btn {
      border: 2px solid var(--ink);
      background: var(--add-blue);
      padding: 10px 12px;
      font: inherit;
      cursor: pointer;
      box-shadow: -4px 4px 0 var(--ink);
      user-select: none;
    }

    .btn:active { transform: translateY(1px); }
    .btn.clear { background: var(--danger); }
    .btn.reset { background: #eee; }

    ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 10px;
    }

    li.item {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 2px solid var(--ink);
      padding: 10px;
      background: var(--pale);
      cursor: pointer;
      user-select: none;
    }

    li.item.dragging { opacity: 0.5; }

    /* Thin insertion line */
    li.item.drop-before::before,
    li.item.drop-after::after {
      content: "";
      position: absolute;
      left: 8px;
      right: 8px;
      height: 3px;
      background: var(--insert-line);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.55);
      border-radius: 99px;
      pointer-events: none;
    }

    li.item.drop-before::before { top: -7px; }
    li.item.drop-after::after { bottom: -7px; }

    li.item.done {
      opacity: 0.9;
      background: var(--done);
    }

    li.item.all-done {
      background: var(--done-strong);
    }

    .check {
      width: 22px;
      height: 22px;
      accent-color: var(--ink);
      cursor: pointer;
      flex: 0 0 auto;
    }

    .text {
      flex: 1;
      min-width: 0;
      word-break: break-word;
    }

    li.item.done .text { text-decoration: line-through; }

    .delete {
      border: 2px solid var(--ink);
      background: var(--warn);
      width: 34px;
      height: 34px;
      cursor: pointer;
      font-weight: bold;
      line-height: 1;
      flex: 0 0 auto;
    }

    .meta {
      margin-top: 14px;
      font-size: 0.92rem;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .empty {
      text-align: center;
      opacity: 0.7;
      padding: 12px;
      border: 2px dashed var(--ink);
      background: var(--card);
    }

    .celebrate li.item {
      animation: flashPalette 250ms linear infinite;
    }

    @keyframes flashPalette {
      0%   { background: var(--done); }
      25%  { background: var(--add-blue); }
      50%  { background: var(--warn); }
      75%  { background: var(--danger); }
      100% { background: var(--done); }
    }

    #confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }

    @media (max-width: 640px) {
      .controls { gap: 14px; }
      .btn { box-shadow: -3px 3px 0 var(--ink); }
    }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <main class="wrap">
    <div class="topbar">
      <a class="back" href="index.html">← Back</a>
      <div class="date" id="today"></div>
    </div>

    <div class="title-wrap">
      <h1 class="title" id="title">Daily Checklist</h1>
    </div>

    <section class="card" id="card">
      <div class="controls">
        <input id="newItem" type="text" placeholder="Add a checklist item..." maxlength="120" />
        <button class="btn" id="addBtn">Add</button>
      </div>
      <div class="controls">
        <button class="btn clear" id="clearDoneBtn">Clear checked</button>
        <button class="btn reset" id="resetDailyBtn">Reset all checks</button>
      </div>

      <ul id="list"></ul>
      <div id="emptyState" class="empty" hidden>No items yet. Add one above.</div>

      <div class="meta">
        <span id="progress">0 / 0 done</span>
        <span>Saved automatically</span>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'muggzy-daily-checklist-v3';
    const CELEBRATION_KEY = 'muggzy-daily-checklist-last-celebrated';

    const defaultItems = [
      { text: 'Wake up on time', done: false },
      { text: 'Drink water', done: false },
      { text: 'Workout / move', done: false },
      { text: 'Main priority task', done: false },
      { text: 'Plan tomorrow', done: false }
    ];

    const listEl = document.getElementById('list');
    const emptyStateEl = document.getElementById('emptyState');
    const progressEl = document.getElementById('progress');
    const inputEl = document.getElementById('newItem');
    const addBtn = document.getElementById('addBtn');
    const clearDoneBtn = document.getElementById('clearDoneBtn');
    const resetDailyBtn = document.getElementById('resetDailyBtn');
    const todayEl = document.getElementById('today');
    const titleEl = document.getElementById('title');
    const cardEl = document.getElementById('card');

    function todayString() {
      const d = new Date();
      return d.toLocaleDateString(undefined, {
        weekday: 'short',
        month: 'short',
        day: 'numeric'
      });
    }
    todayEl.textContent = todayString();

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultItems);
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return structuredClone(defaultItems);
        return parsed
          .filter(x => x && typeof x.text === 'string')
          .map(x => ({ text: x.text.slice(0, 120), done: !!x.done }));
      } catch {
        return structuredClone(defaultItems);
      }
    }

    let items = loadState();

    // Drag state
    let dragFromIndex = null;
    let dragOverIndex = null;
    let dragInsertAfter = false;

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function allDone() {
      return items.length > 0 && items.every(i => i.done);
    }

    function didCelebrateToday() {
      const last = localStorage.getItem(CELEBRATION_KEY);
      const today = new Date().toISOString().slice(0, 10);
      return last === today;
    }

    function markCelebratedToday() {
      const today = new Date().toISOString().slice(0, 10);
      localStorage.setItem(CELEBRATION_KEY, today);
    }

    // --- Confetti ---
    function launchConfetti(durationMs = 2400) {
      const canvas = document.getElementById('confetti');
      const ctx = canvas.getContext('2d');

      function resize() {
        canvas.width = window.innerWidth * devicePixelRatio;
        canvas.height = window.innerHeight * devicePixelRatio;
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      }

      resize();
      canvas.style.display = 'block';

      const palette = ['#b8e8ff', '#ffe4a8', '#ffd6d6', '#e8ffe8', '#ffffff'];
      const pieces = Array.from({ length: 140 }, () => ({
        x: Math.random() * window.innerWidth,
        y: -20 - Math.random() * window.innerHeight * 0.4,
        r: 4 + Math.random() * 5,
        w: 6 + Math.random() * 8,
        h: 8 + Math.random() * 10,
        vx: -2 + Math.random() * 4,
        vy: 2 + Math.random() * 5,
        rot: Math.random() * Math.PI,
        vr: (-0.15 + Math.random() * 0.3),
        c: palette[Math.floor(Math.random() * palette.length)],
        shape: Math.random() < 0.55 ? 'rect' : 'circle'
      }));

      let start = performance.now();
      let rafId = null;

      function frame(t) {
        const elapsed = t - start;
        ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

        for (const p of pieces) {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.03;
          p.rot += p.vr;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.c;

          if (p.shape === 'rect') {
            ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          } else {
            ctx.beginPath();
            ctx.arc(0, 0, p.r, 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.restore();
        }

        if (elapsed < durationMs) {
          rafId = requestAnimationFrame(frame);
        } else {
          cancelAnimationFrame(rafId);
          canvas.style.display = 'none';
        }
      }

      window.addEventListener('resize', resize, { once: true });
      requestAnimationFrame(frame);
    }

    function celebrateIfComplete() {
      if (!allDone()) {
        cardEl.classList.remove('celebrate');
        titleEl.classList.remove('done');
        return;
      }

      titleEl.classList.add('done');

      if (!didCelebrateToday()) {
        markCelebratedToday();
        cardEl.classList.add('celebrate');
        launchConfetti(2600);
        setTimeout(() => {
          cardEl.classList.remove('celebrate');
          document.querySelectorAll('li.item.done').forEach(li => li.classList.add('all-done'));
        }, 2400);
      } else {
        document.querySelectorAll('li.item.done').forEach(li => li.classList.add('all-done'));
      }
    }

    function updateProgress() {
      const doneCount = items.filter(i => i.done).length;
      progressEl.textContent = `${doneCount} / ${items.length} done`;
    }

    function clearInsertionLines() {
      document.querySelectorAll('li.item').forEach(el => {
        el.classList.remove('drop-before', 'drop-after');
      });
    }

    function render() {
      listEl.innerHTML = '';
      emptyStateEl.hidden = items.length !== 0;

      items.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'item' + (item.done ? ' done' : '');
        li.draggable = true;
        li.dataset.index = String(index);
        li.setAttribute('role', 'button');
        li.setAttribute('tabindex', '0');
        li.setAttribute('aria-pressed', item.done ? 'true' : 'false');

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'check';
        checkbox.checked = item.done;

        const span = document.createElement('span');
        span.className = 'text';
        span.textContent = item.text;

        const del = document.createElement('button');
        del.className = 'delete';
        del.type = 'button';
        del.setAttribute('aria-label', `Delete ${item.text}`);
        del.textContent = '×';

        // Click anywhere on item toggles, except delete button / checkbox
        li.addEventListener('click', (e) => {
          if (e.target === del) return;
          if (e.target === checkbox) return;
          checkbox.checked = !checkbox.checked;
          items[index].done = checkbox.checked;
          saveState();
          render();
        });

        // Keyboard toggle
        li.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            checkbox.checked = !checkbox.checked;
            items[index].done = checkbox.checked;
            saveState();
            render();
          }
        });

        checkbox.addEventListener('change', () => {
          items[index].done = checkbox.checked;
          saveState();
          render();
        });

        del.addEventListener('click', (e) => {
          e.stopPropagation();
          items.splice(index, 1);
          saveState();
          render();
        });

        // Drag & drop reorder with insertion line
        li.addEventListener('dragstart', () => {
          dragFromIndex = index;
          li.classList.add('dragging');
        });

        li.addEventListener('dragend', () => {
          dragFromIndex = null;
          dragOverIndex = null;
          dragInsertAfter = false;
          li.classList.remove('dragging');
          clearInsertionLines();
        });

        li.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (dragFromIndex === null) return;

          const rect = li.getBoundingClientRect();
          const midY = rect.top + rect.height / 2;
          const after = e.clientY > midY;

          dragOverIndex = index;
          dragInsertAfter = after;

          clearInsertionLines();
          li.classList.add(after ? 'drop-after' : 'drop-before');
        });

        li.addEventListener('dragleave', () => {
          li.classList.remove('drop-before', 'drop-after');
        });

        li.addEventListener('drop', (e) => {
          e.preventDefault();
          if (dragFromIndex === null || dragOverIndex === null) return;

          const from = dragFromIndex;
          const over = dragOverIndex;
          const insertAfter = dragInsertAfter;

          clearInsertionLines();

          let insertIndex = over + (insertAfter ? 1 : 0);
          if (from < insertIndex) insertIndex -= 1;
          insertIndex = Math.max(0, Math.min(items.length, insertIndex));

          const moved = items.splice(from, 1)[0];
          items.splice(insertIndex, 0, moved);

          saveState();
          render();
        });

        li.appendChild(checkbox);
        li.appendChild(span);
        li.appendChild(del);
        listEl.appendChild(li);
      });

      updateProgress();

      if (allDone()) {
        document.querySelectorAll('li.item.done').forEach(li => li.classList.add('all-done'));
      }

      celebrateIfComplete();
    }

    function addItem() {
      const text = inputEl.value.trim();
      if (!text) return;
      items.push({ text, done: false });
      inputEl.value = '';
      saveState();
      render();
      inputEl.focus();
    }

    addBtn.addEventListener('click', addItem);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addItem();
    });

    clearDoneBtn.addEventListener('click', () => {
      items = items.filter(item => !item.done);
      saveState();
      render();
    });

    resetDailyBtn.addEventListener('click', () => {
      items = items.map(item => ({ ...item, done: false }));
      saveState();
      render();
    });

    // Allow dropping at end by dragging below the last item
    listEl.addEventListener('dragover', (e) => {
      if (dragFromIndex === null) return;
      e.preventDefault();

      const last = listEl.querySelector('li.item:last-child');
      if (!last) return;
      const rect = last.getBoundingClientRect();
      if (e.clientY > rect.bottom) {
        document.querySelectorAll('li.item').forEach(el => el.classList.remove('drop-before', 'drop-after'));
        last.classList.add('drop-after');
        dragOverIndex = items.length - 1;
        dragInsertAfter = true;
      }
    });

    render();
  </script>
</body>
</html>
