<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog</title>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }

    body {
      background: #efefef;
      color: #222;
      font-family: Georgia, "Times New Roman", serif;
      line-height: 1.48;
    }

    .site-header {
      border-bottom: 1px solid #222;
      background: #efefef;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .site-header-inner {
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
    }

    .brand {
      font-size: clamp(22px, 2.2vw, 28px);
      font-weight: 700;
      color: #111;
    }

    .nav a {
      color: #222;
      text-decoration: none;
      font-size: 0.98rem;
    }

    .page {
      max-width: 1320px;
      margin: 0 auto;
      padding: 22px;
      display: grid;
      grid-template-columns: 88px minmax(0, 760px) 88px;
      gap: 8px;
      align-items: start;
    }

    .arrow-col {
      position: sticky;
      top: 88px;
      height: calc(100vh - 100px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .arrow-stack {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .arrow-btn {
      width: 48px;
      height: 48px;
      border: 1px solid #222;
      border-radius: 999px;
      background: #f8f8f8;
      color: #111;
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .arrow-btn.small {
      width: 42px;
      height: 42px;
      font-size: 18px;
    }

    .arrow-btn:hover { background: #fff; }
    .arrow-btn:disabled {
      opacity: 0.35;
      cursor: default;
      background: #efefef;
    }

    .article {
      padding: 8px 0 32px;
      min-height: calc(100vh - 140px);
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .toolbar .left {
      color: #666;
      font-size: 0.9rem;
    }

    .toolbar button {
      border: 1px solid #222;
      background: #fafafa;
      padding: 6px 10px;
      font: inherit;
      cursor: pointer;
    }

    .toolbar button:hover { background: #fff; }

    .article h1 {
      margin: 0 0 4px;
      font-size: clamp(28px, 3.3vw, 40px);
      line-height: 1.1;
      color: #111;
    }

    .article .date {
      color: #666;
      font-size: 0.95rem;
      margin-bottom: 18px;
    }

    .article p {
      margin: 0 0 12px;
      font-size: 1.02rem;
      color: #2a2a2a;
      line-height: 1.42;
    }

    .article p:last-child { margin-bottom: 0; }

    .editor {
      display: none;
      border: 1px solid #222;
      background: #f7f7f7;
      padding: 12px;
      margin: 0 0 16px;
    }

    .editor.active { display: block; }

    .editor-grid {
      display: grid;
      gap: 8px;
    }

    .editor label {
      font-size: 0.9rem;
      color: #444;
    }

    .editor input,
    .editor textarea {
      width: 100%;
      border: 1px solid #222;
      background: #fff;
      padding: 8px;
      font: inherit;
    }

    .editor textarea {
      min-height: 180px;
      resize: vertical;
      line-height: 1.35;
    }

    .editor-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .editor-actions button {
      border: 1px solid #222;
      background: #fff;
      padding: 8px 10px;
      font: inherit;
      cursor: pointer;
    }

    .editor-actions .primary {
      background: #e8f0ff;
      font-weight: 600;
    }

    .editor-note {
      color: #666;
      font-size: 0.86rem;
    }

    .mobile-controls {
      display: none;
      margin-top: 22px;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .mobile-controls .arrow-btn {
      width: auto;
      min-width: 70px;
      border-radius: 0;
      padding: 10px 12px;
      font-size: 15px;
      gap: 6px;
      height: auto;
    }

    .post-count {
      color: #666;
      font-size: 0.94rem;
      text-align: center;
      margin-top: 14px;
    }

    @media (max-width: 920px) {
      .page { grid-template-columns: 1fr; }
      .arrow-col { display: none; }
      .article { min-height: auto; }
      .mobile-controls { display: flex; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="site-header-inner">
      <div class="brand">Cole Firlie</div>
      <nav class="nav" aria-label="Top navigation">
        <a href="index.html">Home</a>
      </nav>
    </div>
  </header>

  <main class="page">
    <div class="arrow-col">
      <div class="arrow-stack">
        <button id="firstBtn" class="arrow-btn small" aria-label="First (newest) entry">«</button>
        <button id="prevBtn" class="arrow-btn" aria-label="Newer entry">←</button>
      </div>
    </div>

    <article class="article" aria-live="polite">
      <div class="toolbar">
        <div class="left" id="status">Loading posts…</div>
        <button id="adminBtn" type="button">Edit</button>
      </div>

      <section id="editorPanel" class="editor" aria-label="Post editor">
        <div class="editor-grid">
          <div>
            <label for="editTitle">Title</label>
            <input id="editTitle" type="text" maxlength="180" />
          </div>
          <div>
            <label for="editDate">Date (YYYY-MM-DD or anything)</label>
            <input id="editDate" type="text" placeholder="2026-02-25" maxlength="80" />
          </div>
          <div>
            <label for="editBody">Body (one paragraph per blank line)</label>
            <textarea id="editBody"></textarea>
          </div>
        </div>
        <div class="editor-actions">
          <button id="newPostBtn" type="button">New post</button>
          <button id="saveDraftBtn" type="button">Save edits</button>
          <button id="publishBtn" class="primary" type="button">Publish</button>
          <button id="deletePostBtn" type="button">Delete post</button>
          <button id="exitEditBtn" type="button">Close editor</button>
          <span class="editor-note">Publish commits to posts.json on GitHub (you’ll paste a token).</span>
        </div>
      </section>

      <h1 id="postTitle">—</h1>
      <div class="date" id="postDate"></div>
      <div id="postBody"></div>

      <div class="mobile-controls">
        <button id="firstBtnMobile" class="arrow-btn" aria-label="First (newest) entry">« First</button>
        <button id="prevBtnMobile" class="arrow-btn" aria-label="Newer entry">← Newer</button>
        <button id="nextBtnMobile" class="arrow-btn" aria-label="Older entry">Older →</button>
        <button id="lastBtnMobile" class="arrow-btn" aria-label="Last (oldest) entry">Last »</button>
      </div>

      <div class="post-count" id="postCount"></div>
    </article>

    <div class="arrow-col">
      <div class="arrow-stack">
        <button id="nextBtn" class="arrow-btn" aria-label="Older entry">→</button>
        <button id="lastBtn" class="arrow-btn small" aria-label="Last (oldest) entry">»</button>
      </div>
    </div>
  </main>

  <script>
    // ===== CONFIG =====
    // Your GitHub repo that hosts the site:
    const GITHUB_OWNER = 'colefirlie';
    const GITHUB_REPO = 'muggzy';
    const GITHUB_BRANCH = 'main';
    const POSTS_PATH = 'posts.json';

    // ===== STATE =====
    let posts = [];
    let current = 0; // newest first
    let adminMode = false;

    // ===== ELEMENTS =====
    const statusEl = document.getElementById('status');

    const titleEl = document.getElementById('postTitle');
    const dateEl = document.getElementById('postDate');
    const bodyEl = document.getElementById('postBody');
    const countEl = document.getElementById('postCount');

    const editorPanel = document.getElementById('editorPanel');
    const adminBtn = document.getElementById('adminBtn');
    const editTitle = document.getElementById('editTitle');
    const editDate = document.getElementById('editDate');
    const editBody = document.getElementById('editBody');

    const prevBtns = [document.getElementById('prevBtn'), document.getElementById('prevBtnMobile')];
    const nextBtns = [document.getElementById('nextBtn'), document.getElementById('nextBtnMobile')];
    const firstBtns = [document.getElementById('firstBtn'), document.getElementById('firstBtnMobile')];
    const lastBtns = [document.getElementById('lastBtn'), document.getElementById('lastBtnMobile')];

    // ===== HELPERS =====
    function normalizePosts(arr) {
      const cleaned = (Array.isArray(arr) ? arr : []).map(p => ({
        title: typeof p.title === 'string' ? p.title : 'Untitled',
        date: typeof p.date === 'string' ? p.date : '',
        body: Array.isArray(p.body) ? p.body.filter(s => typeof s === 'string') : []
      }));
      // Ensure newest-first by sorting if dates are ISO-ish
      cleaned.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
      return cleaned;
    }

    async function fetchPosts() {
      // Cache-bust so updates show quickly
      const url = `${POSTS_PATH}?v=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Could not load ${POSTS_PATH} (HTTP ${res.status})`);
      const data = await res.json();
      return normalizePosts(data);
    }

    function fillEditorFromCurrent() {
      const post = posts[current];
      editTitle.value = post.title;
      editDate.value = post.date;
      editBody.value = post.body.join('\n\n');
    }

    function editorToPost() {
      const title = editTitle.value.trim() || 'Untitled';
      const date = editDate.value.trim();
      const body = editBody.value
        .split(/\n{2,}|\r\n\r\n/)
        .map(s => s.trim())
        .filter(Boolean);
      return { title, date, body: body.length ? body : [''] };
    }

    function setAdminUI() {
      adminBtn.textContent = adminMode ? 'Editing' : 'Edit';
      editorPanel.classList.toggle('active', adminMode);
      if (adminMode) fillEditorFromCurrent();
    }

    function renderPost(scrollTop = false) {
      if (!posts.length) {
        titleEl.textContent = 'No posts yet';
        dateEl.textContent = '';
        bodyEl.innerHTML = '';
        countEl.textContent = '';
        return;
      }

      const post = posts[current];
      titleEl.textContent = post.title;
      dateEl.textContent = post.date;
      bodyEl.innerHTML = '';

      post.body.forEach(par => {
        const p = document.createElement('p');
        p.textContent = par;
        bodyEl.appendChild(p);
      });

      countEl.textContent = `Entry ${current + 1} of ${posts.length}`;

      const atNewest = current === 0;
      const atOldest = current === posts.length - 1;

      prevBtns.forEach(btn => btn.disabled = atNewest);
      firstBtns.forEach(btn => btn.disabled = atNewest);
      nextBtns.forEach(btn => btn.disabled = atOldest);
      lastBtns.forEach(btn => btn.disabled = atOldest);

      if (adminMode) fillEditorFromCurrent();
      if (scrollTop) window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goPrev() { if (current > 0) { current -= 1; renderPost(true); } }
    function goNext() { if (current < posts.length - 1) { current += 1; renderPost(true); } }
    function goFirst() { if (current !== 0) { current = 0; renderPost(true); } }
    function goLast() { if (current !== posts.length - 1) { current = posts.length - 1; renderPost(true); } }

    prevBtns.forEach(btn => btn.addEventListener('click', goPrev));
    nextBtns.forEach(btn => btn.addEventListener('click', goNext));
    firstBtns.forEach(btn => btn.addEventListener('click', goFirst));
    lastBtns.forEach(btn => btn.addEventListener('click', goLast));

    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') goPrev();
      if (e.key === 'ArrowRight') goNext();
      if (e.key === 'Home') goFirst();
      if (e.key === 'End') goLast();
    });

    function b64EncodeUnicode(str) {
      // btoa but safe for unicode
      return btoa(unescape(encodeURIComponent(str)));
    }

    async function getCurrentFileSha(token) {
      const api = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${POSTS_PATH}?ref=${GITHUB_BRANCH}`;
      const res = await fetch(api, {
        headers: {
          'Accept': 'application/vnd.github+json',
          'Authorization': `Bearer ${token}`
        }
      });
      if (res.status === 404) return null;
      if (!res.ok) throw new Error(`GitHub read failed (HTTP ${res.status})`);
      const json = await res.json();
      return json.sha || null;
    }

    async function commitPostsToGitHub(token, newPosts) {
      const sha = await getCurrentFileSha(token);
      const api = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${POSTS_PATH}`;
      const content = JSON.stringify(newPosts, null, 2) + '\n';
      const payload = {
        message: `Update ${POSTS_PATH} via blog editor`,
        content: b64EncodeUnicode(content),
        branch: GITHUB_BRANCH,
        ...(sha ? { sha } : {})
      };

      const res = await fetch(api, {
        method: 'PUT',
        headers: {
          'Accept': 'application/vnd.github+json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`GitHub write failed (HTTP ${res.status}). ${text}`);
      }
    }

    // ===== EDIT UI =====
    adminBtn.addEventListener('click', () => {
      adminMode = !adminMode;
      setAdminUI();
    });

    document.getElementById('saveDraftBtn').addEventListener('click', () => {
      if (!adminMode) return;
      posts[current] = editorToPost();
      posts = normalizePosts(posts);
      current = 0; // keep newest-first view after edits
      statusEl.textContent = 'Draft updated (not published)';
      renderPost();
    });

    document.getElementById('newPostBtn').addEventListener('click', () => {
      if (!adminMode) return;
      const todayISO = new Date().toISOString().slice(0, 10);
      posts.unshift({ title: 'New Post', date: todayISO, body: ['Write here...'] });
      posts = normalizePosts(posts);
      current = 0;
      statusEl.textContent = 'New post created (not published)';
      renderPost();
    });

    document.getElementById('deletePostBtn').addEventListener('click', () => {
      if (!adminMode || posts.length <= 1) return;
      if (!confirm('Delete this post?')) return;
      posts.splice(current, 1);
      if (current >= posts.length) current = posts.length - 1;
      statusEl.textContent = 'Post deleted (not published)';
      renderPost();
    });

    document.getElementById('exitEditBtn').addEventListener('click', () => {
      adminMode = false;
      setAdminUI();
      statusEl.textContent = 'Viewing';
    });

    document.getElementById('publishBtn').addEventListener('click', async () => {
      if (!adminMode) return;

      posts[current] = editorToPost();
      posts = normalizePosts(posts);
      current = 0;
      renderPost();

      const token = window.prompt(
        'Paste a GitHub fine-grained token with Contents: Read & Write for this repo.\n' +
        'It will NOT be saved — used once to commit posts.json.'
      );
      if (!token) return;

      statusEl.textContent = 'Publishing…';
      try {
        await commitPostsToGitHub(token.trim(), posts);
        statusEl.textContent = 'Published! (Committed to posts.json)';
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Publish failed: ${err.message}`;
        alert('Publish failed. Open console for details. Common causes: token permissions, wrong repo/branch, or Cloudflare caching.');
      }
    });

    // ===== BOOT =====
    (async () => {
      try {
        posts = await fetchPosts();
        current = 0; // newest first
        statusEl.textContent = 'Viewing';
        setAdminUI();
        renderPost();
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Error: ${err.message}`;
        posts = normalizePosts([{ title: 'Could not load posts.json', date: '', body: [String(err.message)] }]);
        current = 0;
        setAdminUI();
        renderPost();
      }
    })();
  </script>
</body>
</html>
